<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capture the Flag - Cybersecurity Challenge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <base href="/ctf-game/">
  <style>
    body {
      background: linear-gradient(to bottom, #1a202c, #2d3748);
      min-height: 100vh;
      color: #e2e8f0;
      font-family: 'Arial', sans-serif;
    }
    .challenge-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .challenge-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center p-4">
  <div class="container max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold text-center mb-8 text-blue-400">Capture the Flag Challenge</h1>

    <!-- Player Info -->
    <div class="mb-6 flex justify-between items-center">
      <div>
        <label for="playerName" class="text-lg">Player Name:</label>
        <input id="playerName" type="text" placeholder="Enter your name" class="p-2 rounded bg-gray-800 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
        <button id="saveName" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
      </div>
      <div class="text-lg">Score: <span id="playerScore">0</span></div>
    </div>

    <!-- Timer -->
    <div class="text-center mb- ytterboard
    <p>Time Remaining: <span id="timer">10:00</span></p>
  </div>

    <!-- Challenges -->
    <div id="challenges" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Challenges will be dynamically inserted here -->
    </div>

    <!-- Leaderboard -->
    <div class="mt-8">
      <h2 class="text-2xl font-bold mb-4">Leaderboard</h2>
      <table class="w-full text-left bg-gray-800 rounded-lg overflow-hidden">
        <thead>
          <tr class="bg-gray-700">
            <th class="p-3">Rank</th>
            <th class="p-3">Player</th>
            <th class="p-3">Score</th>
          </tr>
        </thead>
        <tbody id="leaderboard"></tbody>
      </table>
    </div>
  </div>

  <script>
    // Challenges data
    const challenges = [
      {
        id: 1,
        title: "Base64 Decoder (Novice)",
        description: "Decode this Base64 string to find the flag: ZmxhZ3tjeWJlcl9kZWNvZGVfMW50MH0=",
        points: 100,
        flag: "flag{cyber_decode_1nt0}",
      },
      {
        id: 2,
        title: "Hidden in Source (Novice)",
        description: "Inspect the HTML source of this page. The flag is hidden in a comment. <!-- flag{source_inspector} -->",
        points: 150,
        flag: "flag{source_inspector}",
      },
      {
        id: 3,
        title: "SQL Injection (Beginner)",
        description: "Bypass this login query: SELECT * FROM users WHERE username = 'admin' AND password = '[your input]'. Try ' OR '1'='1'.",
        points: 200,
        flag: "flag{sql_injection_101}",
      },
      {
        id: 4,
        title: "XSS Exploit (Intermediate)",
        description: "The input field below reflects user input unsafely. Craft an XSS payload to trigger an alert with the flag: flag{xss_alert_hunter}. Hint: Try &lt;script&gt;alert('flag{xss_alert_hunter}')&lt;/script&gt;.",
        points: 250,
        flag: "flag{xss_alert_hunter}",
      },
      {
        id: 5,
        title: "Regex Log Parser (Intermediate)",
        description: "Download the log file and use regex to find the flag matching the pattern: flag{[a-z0-9_]+}. <a href='data:text/plain;base64,ZXJyb3I6IGxvZ2luIGZhaWxlZCBhdCAyMDI1LTA1LTI5CmxvZzogZmxhZ3tyZWdleF9sb2dfM2F0ZXJ9IGlzIGhpZGRlbgphdHRlbXB0OiB1c2VyID0gYWRtaW4=' download='access.log'>Download Log</a>",
        points: 300,
        flag: "flag{regex_log_3ater}",
      },
      {
        id: 6,
        title: "Forensics: Hidden File (Advanced)",
        description: "Analyze the attached file to find the flag. Hint: Check for hidden text or metadata. <a href='data:text/plain;base64,VGhpcyBpcyBhIGRpdmVyc2lvbi4gVGhlIGZsYWcgaXMgaGlkZGVuIGluIHRoZSBmaWxlIG1ldGFkYXRhLiBGbGFnOiBmbGFne2ZvcmVuc2ljX21ldGFfZmluZH0=' download='decoy.txt'>Download File</a>",
        points: 350,
        flag: "flag{forensic_meta_find}",
      },
      {
        id: 7,
        title: "Caesar Cipher (Beginner)",
        description: "Decrypt this Caesar cipher (shift 3): iohj{fubswr_bhdobhvw}. Hint: Shift each letter back by 3.",
        points: 200,
        flag: "flag{crypto_analyzer}",
      },
      {
        id: 8,
        title: "Steganography: Hidden Image (Advanced)",
        description: "Extract the flag from this image. Hint: Look for hidden text in the least significant bits. <img src='assets/stego.png' alt='stego image' class='w-32 h-auto'> Flag: flag{stego_bit_magic}",
        points: 400,
        flag: "flag{stego_bit_magic}",
      },
      {
        id: 9,
        title: "Reverse Engineering (Expert)",
        description: "Analyze this JS code to find the flag: <code>function secret(){let x='flag{rev_eng_1337}';return x.split('').reverse().join('');}</code>. Hint: Execute or reverse the output.",
        points: 450,
        flag: "flag{rev_eng_1337}",
      },
      {
        id: 10,
        title: "Pwn: Buffer Overflow (Expert)",
        description: "Simulate a buffer overflow by entering this exact input to bypass the check: overflow{flag{pwn_0verfl0w}}. No actual binary, just enter the flag.",
        points: 500,
        flag: "flag{pwn_0verfl0w}",
      },
      {
        id: 11,
        title: "Hidden API Endpoint (Intermediate)",
        description: "Find the hidden API endpoint in the page source. Hint: Look for a commented-out script tag. <!-- <script src='/api/flag{hidden_endpoint_007}'></script> -->",
        points: 300,
        flag: "flag{hidden_endpoint_007}",
      },
    ];

    // Game state
    let player = { name: "Anonymous", score: 0 };
    let timeLeft = 600; // 10 minutes in seconds
    let timerInterval;
    let leaderboard = [];

    // Helper function to escape HTML
    function escapeHTML(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    // Load player data from localStorage
    if (localStorage.getItem("ctfPlayer")) {
      player = JSON.parse(localStorage.getItem("ctfPlayer"));
    }
    if (localStorage.getItem("ctfLeaderboard")) {
      leaderboard = JSON.parse(localStorage.getItem("ctfLeaderboard"));
    }

    // Update UI with player data
    document.getElementById("playerScore").textContent = player.score;
    document.getElementById("playerName").value = player.name;

    // Save player name
    document.getElementById("saveName").addEventListener("click", () => {
      const name = document.getElementById("playerName").value.trim();
      if (name) {
        player.name = name;
        localStorage.setItem("ctfPlayer", JSON.stringify(player));
        updateLeaderboard();
      }
    });

    // Timer logic
    function startTimer() {
      timerInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById("timer").textContent = `${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          alert("Time's up! Game over.");
          document.querySelectorAll(".submit-flag").forEach(btn => btn.disabled = true);
        }
      }, 1000);
    }

    // Render challenges using DOM methods
    function renderChallenges() {
      const challengesDiv = document.getElementById("challenges");
      if (!challengesDiv) {
        console.error("Challenges container not found!");
        return;
      }
      challengesDiv.innerHTML = ""; // Clear existing content
      console.log(`Rendering ${challenges.length} challenges`);

      challenges.forEach(challenge => {
        try {
          // Create card container
          const card = document.createElement("div");
          card.className = "challenge-card bg-gray-800 p-6 rounded-lg shadow-lg";

          // Title
          const title = document.createElement("h3");
          title.className = "text-xl font-bold mb-2 text-blue-400";
          title.textContent = challenge.title;
          card.appendChild(title);

          // Description (allow HTML by setting innerHTML safely)
          const description = document.createElement("div");
          description.className = "mb-4";
          description.innerHTML = challenge.description;
          card.appendChild(description);

          // Points
          const points = document.createElement("p");
          points.className = "mb-4";
          points.textContent = `Points: ${challenge.points}`;
          card.appendChild(points);

          // Input field
          const input = document.createElement("input");
          input.type = "text";
          input.id = `flag-${challenge.id}`;
          input.placeholder = "Enter flag";
          input.className = "p-2 rounded bg-gray-700 text-white border border-gray-600 w-full mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400";
          card.appendChild(input);

          // Submit button
          const button = document.createElement("button");
          button.className = "submit-flag bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700";
          button.dataset.id = challenge.id;
          button.textContent = "Submit Flag";
          card.appendChild(button);

          challengesDiv.appendChild(card);
          console.log(`Rendered challenge ${challenge.id}: ${challenge.title}`);
        } catch (error) {
          console.error(`Error rendering challenge ${challenge.id}:`, error);
        }
      });

      // Add event listeners for flag submission
      const buttons = document.querySelectorAll(".submit-flag");
      console.log(`Found ${buttons.length} submit buttons`);
      buttons.forEach(button => {
        button.addEventListener("click", () => {
          const challengeId = parseInt(button.dataset.id);
          const challenge = challenges.find(c => c.id === challengeId);
          if (!challenge) {
            console.error(`Challenge ${challengeId} not found`);
            return;
          }
          const input = document.getElementById(`flag-${challengeId}`);
          if (!input) {
            console.error(`Input for challenge ${challengeId} not found`);
            return;
          }
          const submittedFlag = input.value.trim();
          if (submittedFlag === challenge.flag) {
            player.score += challenge.points;
            document.getElementById("playerScore").textContent = player.score;
            localStorage.setItem("ctfPlayer", JSON.stringify(player));
            updateLeaderboard();
            button.disabled = true;
            alert(`Correct! You captured the flag for ${challenge.title} and earned ${challenge.points} points!`);
          } else {
            alert("Incorrect flag. Try again!");
          }
        });
      });
    }

    // Update leaderboard
    function updateLeaderboard() {
      const existing = leaderboard.find(entry => entry.name === player.name);
      if (existing) {
        existing.score = player.score;
      } else {
        leaderboard.push({ name: player.name, score: player.score });
      }
      leaderboard.sort((a, b) => b.score - a.score);
      localStorage.setItem("ctfLeaderboard", JSON.stringify(leaderboard));

      const leaderboardBody = document.getElementById("leaderboard");
      leaderboardBody.innerHTML = "";
      leaderboard.forEach((entry, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="p-3">${index + 1}</td>
          <td class="p-3">${entry.name}</td>
          <td class="p-3">${entry.score}</td>
        `;
        leaderboardBody.appendChild(row);
      });
    }

    // Initialize game
    try {
      console.log("Initializing game...");
      renderChallenges();
      updateLeaderboard();
      startTimer();
    } catch (error) {
      console.error("Initialization error:", error);
      alert("Failed to initialize the game. Please check the console for errors.");
    }
  </script>
</body>
</html>
